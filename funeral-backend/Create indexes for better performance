db.repositories.createIndex({ "name": 1 }, { unique: true });
db.manifests.createIndex({ "repository_name": 1, "tag": 1 });
db.manifests.createIndex({ "repository_name": 1, "digest": 1 });
db.manifests.createIndex({ "digest": 1 }, { unique: true });
db.blobs.createIndex({ "digest": 1 }, { unique: true });

print("Database initialized successfully");

# Development environment setup script
#!/bin/bash
# dev-setup.sh

echo "Setting up OCI Registry development environment..."

# Start MongoDB and MinIO
docker-compose up -d mongodb minio mongo-init minio-init

# Wait for services to be ready
echo "Waiting for services to start..."
sleep 30

# Build and run backend
echo "Starting backend..."
./mvnw quarkus:dev &

# Wait for backend to start
sleep 10

# Start frontend
echo "Starting frontend..."
cd frontend
npm install
npm run dev &

echo "Development environment ready!"
echo "Frontend: http://localhost:5173"
echo "Backend: http://localhost:8080"
echo "MinIO Console: http://localhost:9001 (minioadmin/minioadmin)"
echo "MongoDB: mongodb://admin:password@localhost:27017/oci_registry"

# Health check script
#!/bin/bash
# health-check.sh

echo "Checking OCI Registry health..."

# Check backend
if curl -f -s http://localhost:8080/v2/ > /dev/null; then
    echo "✅ Backend is healthy"
else
    echo "❌ Backend is not responding"
fi

# Check MongoDB
if mongosh --host localhost:27017 --eval "db.adminCommand('ping')" --quiet > /dev/null 2>&1; then
    echo "✅ MongoDB is healthy"
else
    echo "❌ MongoDB is not responding"
fi

# Check MinIO
if curl -f -s http://localhost:9000/minio/health/live > /dev/null; then
    echo "✅ MinIO is healthy"
else
    echo "❌ MinIO is not responding"
fi

# README.md - Updated
# OCI Distribution Spec Registry

A complete implementation of the OCI Distribution Specification using Quarkus (backend), Vue 3 (frontend), MongoDB, and MinIO S3.

## Architecture

- **Backend**: Quarkus with MongoDB for metadata storage
- **Storage**: MinIO S3-compatible object storage for blob data
- **Frontend**: Vue 3 with Tailwind CSS
- **Database**: MongoDB with replica set for transaction support

## Features

- ✅ Full OCI Distribution Spec v1.0 compliance
- ✅ Manifest API (GET, PUT, DELETE)
- ✅ Blob API (GET, POST, PUT, DELETE) with S3 storage
- ✅ Tag listing API
- ✅ Repository management
- ✅ Web UI for registry management
- ✅ Docker/Podman compatible
- ✅ MongoDB storage for metadata
- ✅ MinIO S3 storage for blob data
- ✅ High availability and scalability

## Quick Start

1. **Start with Docker Compose:**
   ```bash
   docker-compose up -d
   ```

2. **Access the services:**
   - Web Interface: http://localhost:3000
   - Registry API: http://localhost:8080
   - MinIO Console: http://localhost:9001 (minioadmin/minioadmin)

3. **Configure Docker for insecure registry:**
   ```json
   {
     "insecure-registries": ["localhost:8080"]
   }
   ```

4. **Push an image:**
   ```bash
   docker tag alpine:latest localhost:8080/alpine:latest
   docker push localhost:8080/alpine:latest
   ```

## Development

**Prerequisites:**
- Java 17+
- Node.js 18+
- Docker & Docker Compose

**Setup development environment:**
```bash
chmod +x dev-setup.sh
./dev-setup.sh
```

**Manual setup:**

1. **Start dependencies:**
   ```bash
   docker-compose up -d mongodb minio mongo-init minio-init
   ```

2. **Run backend:**
   ```bash
   ./mvnw quarkus:dev
   ```

3. **Run frontend:**
   ```bash
   cd frontend
   npm install
   npm run dev
   ```

## Configuration

**Environment Variables:**

| Variable | Default | Description |
|----------|---------|-------------|
| MONGO_URL | mongodb://localhost:27017 | MongoDB connection string |
| MONGO_DATABASE | oci_registry | MongoDB database name |
| S3_ENDPOINT | http://localhost:9000 | MinIO S3 endpoint |
| S3_ACCESS_KEY | minioadmin | S3 access key |
| S3_SECRET_KEY | minioadmin | S3 secret key |
| S3_BUCKET | oci-registry | S3 bucket name |

## Storage Architecture

- **Metadata**: Stored in MongoDB collections (repositories, manifests, blobs)
- **Blob Data**: Stored in MinIO S3 with path structure: `blobs/sha256/[hash]`
- **Manifest Content**: Stored as JSON strings in MongoDB
- **Tag Mappings**: Stored in manifest documents

## API Endpoints

- `GET /v2/` - Check API version
- `GET /v2/repositories` - List all repositories
- `GET /v2/{name}/manifests/{reference}` - Get manifest
- `PUT /v2/{name}/manifests/{reference}` - Put manifest
- `DELETE /v2/{name}/manifests/{reference}` - Delete manifest
- `GET /v2/{name}/blobs/{digest}` - Get blob from S3
- `POST /v2/{name}/blobs/uploads/` - Start blob upload
- `PUT /v2/{name}/blobs/uploads/{uuid}` - Complete blob upload to S3
- `GET /v2/{name}/tags/list` - List tags

## Monitoring

**Health checks:**
```bash
chmod +x health-check.sh
./health-check.sh
```

**MinIO metrics:** Available at MinIO console
**MongoDB metrics:** Use MongoDB Compass or monitoring tools

This implementation provides enterprise-grade features with MongoDB's ACID transactions and MinIO's S3-compatible high-performance object storage.
