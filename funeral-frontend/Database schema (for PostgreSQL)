-- Create database
CREATE DATABASE oci_registry;

-- Use the database
\c oci_registry;

-- Create repositories table
CREATE TABLE repositories (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Create manifests table
CREATE TABLE manifests (
    id BIGSERIAL PRIMARY KEY,
    repository_id BIGINT NOT NULL REFERENCES repositories(id) ON DELETE CASCADE,
    digest VARCHAR(255) NOT NULL,
    media_type VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    content_length BIGINT,
    tag VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(digest)
);

-- Create blobs table
CREATE TABLE blobs (
    id BIGSERIAL PRIMARY KEY,
    digest VARCHAR(255) UNIQUE NOT NULL,
    content_length BIGINT,
    media_type VARCHAR(255),
    file_path VARCHAR(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Create indexes for better performance
CREATE INDEX idx_manifests_repository_tag ON manifests(repository_id, tag);
CREATE INDEX idx_manifests_digest ON manifests(digest);
CREATE INDEX idx_blobs_digest ON blobs(digest);

-- Docker Compose file for easy deployment
version: '3.8'
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: oci_registry
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  registry-backend:
    build: .
    ports:
      - "8080:8080"
    environment:
      DB_URL: jdbc:postgresql://postgres:5432/oci_registry
      DB_USERNAME: postgres
      DB_PASSWORD: postgres
      OCI_STORAGE_ROOT: /app/storage
    volumes:
      - registry_storage:/app/storage
    depends_on:
      - postgres

  registry-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:80"
    depends_on:
      - registry-backend

volumes:
  postgres_data:
  registry_storage:

# Frontend Dockerfile
FROM node:18-alpine as build
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80

# nginx.conf for frontend
server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # Handle SPA routing
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Proxy API requests to backend
    location /v2/ {
        proxy_pass http://registry-backend:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Handle large uploads
        client_max_body_size 1000M;
    }
}

# Backend Dockerfile
FROM quarkus/ubi-quarkus-graalvm:22.3-java17 AS build
USER quarkus
WORKDIR /code
COPY --chown=quarkus:quarkus mvnw /code/mvnw
COPY --chown=quarkus:quarkus .mvn /code/.mvn
COPY --chown=quarkus:quarkus pom.xml /code/
COPY --chown=quarkus:quarkus src /code/src
RUN ./mvnw clean package -Pnative

FROM quarkus/ubi-quarkus-micro:latest
WORKDIR /work/

COPY --from=build --chown=185 /code/target/*-runner /work/application
RUN mkdir -p /work/storage && chown 185:185 /work/storage

EXPOSE 8080
USER 185
ENV OCI_STORAGE_ROOT=/work/storage

ENTRYPOINT ["./application", "-Dquarkus.http.host=0.0.0.0"]

# README.md
# OCI Distribution Spec Registry

A complete implementation of the OCI Distribution Specification using Quarkus (backend) and Vue 3 (frontend).

## Features

- ✅ Full OCI Distribution Spec v1.0 compliance
- ✅ Manifest API (GET, PUT, DELETE)
- ✅ Blob API (GET, POST, PUT, DELETE)
- ✅ Tag listing API
- ✅ Repository management
- ✅ Web UI for registry management
- ✅ Docker/Podman compatible
- ✅ PostgreSQL storage for metadata
- ✅ File system storage for blobs

## Quick Start

1. **Start with Docker Compose:**
   ```bash
   docker-compose up -d
   ```

2. **Access the web interface:**
   Open http://localhost:3000

3. **Configure Docker for insecure registry:**
   ```json
   {
     "insecure-registries": ["localhost:8080"]
   }
   ```

4. **Push an image:**
   ```bash
   docker tag alpine:latest localhost:8080/alpine:latest
   docker push localhost:8080/alpine:latest
   ```

## API Endpoints

- `GET /v2/` - Check API version
- `GET /v2/{name}/manifests/{reference}` - Get manifest
- `PUT /v2/{name}/manifests/{reference}` - Put manifest
- `DELETE /v2/{name}/manifests/{reference}` - Delete manifest
- `GET /v2/{name}/blobs/{digest}` - Get blob
- `POST /v2/{name}/blobs/uploads/` - Start blob upload
- `PUT /v2/{name}/blobs/uploads/{uuid}` - Complete blob upload
- `GET /v2/{name}/tags/list` - List tags

## Development

**Backend (Quarkus):**
```bash
./mvnw quarkus:dev
```

**Frontend (Vue 3):**
```bash
npm install
npm run dev
```

## Storage

- **Metadata:** PostgreSQL database
- **Blobs:** File system storage (configurable via `OCI_STORAGE_ROOT`)

This implementation provides a fully functional OCI-compliant container registry with modern web interface.
