name: Build Native Binary

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  JAVA_VERSION: '25'
  GRAALVM_VERSION: '25'

jobs:
  build-jvm:
    name: Build JVM Version
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'maven'

    - name: Build with Maven
      working-directory: ./funeral-backend
      run: mvn -B clean package

    - name: Upload JVM JAR
      uses: actions/upload-artifact@v4
      with:
        name: funeral-jvm-${{ github.sha }}
        path: funeral-backend/target/funeral-*.jar
        retention-days: 7

  build-native:
    name: Build Native Binary with GraalVM
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up GraalVM
      uses: graalvm/setup-graalvm@v1
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'graalvm-community'
        github-token: ${{ secrets.GITHUB_TOKEN }}
        native-image-job-reports: 'true'

    - name: Build Native Binary
      working-directory: ./funeral-backend
      run: |
        mvn -B clean package -Pnative
        # Rename binary for clarity
        if [ -f target/funeral-backend-*-runner ]; then
          mv target/funeral-backend-*-runner target/funeral-runner-linux-amd64
        fi

    - name: Display Binary Info
      working-directory: ./funeral-backend
      run: |
        if [ -f target/funeral-runner-linux-amd64 ]; then
          echo "=== Binary Information ==="
          ls -lh target/funeral-runner-linux-amd64
          file target/funeral-runner-linux-amd64
          echo ""
          echo "=== Binary Size ==="
          du -h target/funeral-runner-linux-amd64
        else
          echo "Native binary not found!"
          ls -la target/
          exit 1
        fi

    - name: Upload Native Binary
      uses: actions/upload-artifact@v4
      with:
        name: funeral-native-${{ github.sha }}
        path: funeral-backend/target/funeral-runner-linux-amd64
        retention-days: 7

    - name: Upload Build Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-reports-${{ github.sha }}
        path: |
          funeral-backend/target/surefire-reports/
          funeral-backend/target/native-tests/
        retention-days: 3

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-jvm, build-native]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - uses: actions/checkout@v4

    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare Release Files
      run: |
        mkdir -p release-files
        # Copy native binary
        find artifacts -name "funeral-runner-linux-amd64" -exec cp {} release-files/ \;
        # Copy JVM JAR
        find artifacts -name "funeral-*.jar" -not -name "*sources*" -not -name "*javadoc*" -exec cp {} release-files/ \;
        # Create checksums
        cd release-files
        sha256sum * > checksums.txt
        cd ..

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Funeral Registry ${{ github.ref_name }}
        draft: false
        prerelease: false
        files: |
          release-files/funeral-runner-linux-amd64
          release-files/funeral-*.jar
          release-files/checksums.txt
        body: |
          ## ğŸ‰ Funeral OCI Registry ${{ github.ref_name }}

          ### ğŸ“¦ Native Binary
          - **File:** `funeral-runner-linux-amd64`
          - **Platform:** Linux x86_64
          - **Features:** Zero-dependency, fast startup

          ### ğŸ“¦ JVM Version
          - **File:** `funeral-*.jar`
          - **Requirements:** Java 17 or higher

          ### ğŸ”§ Quick Start

          #### Using Native Binary
          ```bash
          chmod +x funeral-runner-linux-amd64
          ./funeral-runner-linux-amd64
          ```

          #### Using JVM Version
          ```bash
          java -jar funeral-*.jar
          ```

          ### ğŸ—ï¸ Build Details
          - **Commit:** ${{ github.sha }}
          - **Built with:** GraalVM ${{ env.GRAALVM_VERSION }}
          - **Timestamp:** ${{ github.event.repository.updated_at }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'
